/*!
<<<<<<< HEAD
 * Expressjs | Connect - serve-favicon
=======
 * serve-favicon
>>>>>>> 746d829ab6fde4cbabefa5c385905aefd0043a1d
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */

/**
 * Module dependencies.
<<<<<<< HEAD
 */

var crypto = require('crypto');
var fresh = require('fresh');
var fs = require('fs');
=======
 * @private
 */

var etag = require('etag');
var fresh = require('fresh');
var fs = require('fs');
var ms = require('ms');
>>>>>>> 746d829ab6fde4cbabefa5c385905aefd0043a1d
var path = require('path');
var resolve = path.resolve;

/**
<<<<<<< HEAD
 * Serves the favicon located by the given `path`.
 *
 * @param {String|Buffer} path
 * @param {Object} options
 * @return {Function} middleware
 * @api public
=======
 * Module variables.
 * @private
 */

var maxMaxAge = 60 * 60 * 24 * 365 * 1000; // 1 year

/**
 * Serves the favicon located by the given `path`.
 *
 * @public
 * @param {String|Buffer} path
 * @param {Object} options
 * @return {Function} middleware
>>>>>>> 746d829ab6fde4cbabefa5c385905aefd0043a1d
 */

module.exports = function favicon(path, options){
  options = options || {};

  var buf;
  var icon; // favicon cache
<<<<<<< HEAD
  var maxAge = options.maxAge == null
    ? 86400000
    : Math.min(Math.max(0, options.maxAge), 31556926000);
=======
  var maxAge = calcMaxAge(options.maxAge);
>>>>>>> 746d829ab6fde4cbabefa5c385905aefd0043a1d
  var stat;

  if (!path) throw new TypeError('path to favicon.ico is required');

  if (Buffer.isBuffer(path)) {
    buf = new Buffer(path.length);
    path.copy(buf);

    icon = createIcon(buf, maxAge);
  } else if (typeof path === 'string') {
    path = resolve(path);
    stat = fs.statSync(path);
<<<<<<< HEAD

    if (!stat) throw createNoExistsError(path);
=======
>>>>>>> 746d829ab6fde4cbabefa5c385905aefd0043a1d
    if (stat.isDirectory()) throw createIsDirError(path);
  } else {
    throw new TypeError('path to favicon.ico must be string or buffer');
  }

  return function favicon(req, res, next){
    if ('/favicon.ico' !== req.url) return next();

    if ('GET' !== req.method && 'HEAD' !== req.method) {
      var status = 'OPTIONS' === req.method ? 200 : 405;
      res.writeHead(status, {'Allow': 'GET, HEAD, OPTIONS'});
      res.end();
      return;
    }

    if (icon) return send(req, res, icon);

    fs.readFile(path, function(err, buf){
      if (err) return next(err);
      icon = createIcon(buf, maxAge);
      send(req, res, icon);
    });
  };
};

<<<<<<< HEAD
=======
/**
 * Calculate the max-age from a configured value.
 *
 * @private
 * @param {string|number} val
 * @return {number}
 */

function calcMaxAge(val) {
  var num = typeof val === 'string'
    ? ms(val)
    : val;

  return num != null
    ? Math.min(Math.max(0, num), maxMaxAge)
    : maxMaxAge
}

/**
 * Create icon data from Buffer and max-age.
 *
 * @private
 * @param {Buffer} buf
 * @param {number} maxAge
 * @return {object}
 */

>>>>>>> 746d829ab6fde4cbabefa5c385905aefd0043a1d
function createIcon(buf, maxAge) {
  return {
    body: buf,
    headers: {
<<<<<<< HEAD
      'Content-Type': 'image/x-icon',
      'Content-Length': buf.length,
      'Cache-Control': 'public, max-age=' + ~~(maxAge / 1000),
      'etag': '"' + md5(buf) + '"'
=======
      'Cache-Control': 'public, max-age=' + ~~(maxAge / 1000),
      'ETag': etag(buf)
>>>>>>> 746d829ab6fde4cbabefa5c385905aefd0043a1d
    }
  };
}

<<<<<<< HEAD
=======
/**
 * Create EISDIR error.
 *
 * @private
 * @param {string} path
 * @return {Error}
 */

>>>>>>> 746d829ab6fde4cbabefa5c385905aefd0043a1d
function createIsDirError(path) {
  var error = new Error('EISDIR, illegal operation on directory \'' + path + '\'');
  error.code = 'EISDIR';
  error.errno = 28;
  error.path = path;
  error.syscall = 'open';
  return error;
}

<<<<<<< HEAD
function createNoExistsError(path) {
  var error = new Error('ENOENT, no such file or directory \'' + path + '\'');
  error.code = 'ENOENT';
  error.errno = 34;
  error.path = path;
  error.syscall = 'open';
  return error;
}

function md5(str, encoding){
  return crypto
    .createHash('md5')
    .update(str, 'utf8')
    .digest(encoding || 'hex');
}

function send(req, res, icon){
  var _fresh = fresh(req.headers, icon.headers);
  var buf = _fresh ? '' : icon.body;
  var status = _fresh ? 304 : 200;

  res.writeHead(status, icon.headers);
  res.end(buf);
=======
/**
 * Send icon data in response to a request.
 *
 * @private
 * @param {IncomingMessage} req
 * @param {OutgoingMessage} res
 * @param {object} icon
 */

function send(req, res, icon) {
  var headers = icon.headers;

  // Set headers
  for (var header in headers) {
    res.setHeader(header, headers[header]);
  }

  if (fresh(req.headers, res._headers)) {
    res.statusCode = 304;
    res.end();
    return;
  }

  res.statusCode = 200;
  res.setHeader('Content-Length', icon.body.length);
  res.setHeader('Content-Type', 'image/x-icon');
  res.end(icon.body);
>>>>>>> 746d829ab6fde4cbabefa5c385905aefd0043a1d
}
