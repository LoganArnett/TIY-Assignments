/*!
<<<<<<< HEAD
 * Expressjs | Connect - timeout
 * Ported from https://github.com/LearnBoost/connect-timeout
=======
 * connect-timeout
 * Copyright(c) 2014 Jonathan Ong
 * Copyright(c) 2014 Douglas Christopher Wilson
>>>>>>> 746d829ab6fde4cbabefa5c385905aefd0043a1d
 * MIT Licensed
 */

/**
 * Module dependencies.
 */

<<<<<<< HEAD
var debug = require('debug')('connect:timeout');
=======
var createError = require('http-errors');
var debug = require('debug')('connect:timeout');
var ms = require('ms');
var onHeaders = require('on-headers');
>>>>>>> 746d829ab6fde4cbabefa5c385905aefd0043a1d

/**
 * Timeout:
 *
 * See README.md for documentation.
 *
<<<<<<< HEAD
 * @param {Number} ms
=======
 * @param {Number} time
>>>>>>> 746d829ab6fde4cbabefa5c385905aefd0043a1d
 * @param {Object} options
 * @return {Function} middleware
 * @api public
 */

<<<<<<< HEAD
module.exports = function timeout(ms, options) {
  ms = ms || 5000;
  options = options || {};

=======
module.exports = function timeout(time, options) {
  options = options || {};

  time = typeof time === 'string'
    ? ms(time)
    : Number(time || 5000);

>>>>>>> 746d829ab6fde4cbabefa5c385905aefd0043a1d
  var respond = !('respond' in options) || options.respond === true;

  return function(req, res, next) {
    var destroy = req.socket.destroy;
    var id = setTimeout(function(){
      req.timedout = true;
<<<<<<< HEAD
      req.emit('timeout', ms);
    }, ms);

    if (respond) {
      req.on('timeout', onTimeout(ms, next));
=======
      req.emit('timeout', time);
    }, time);

    if (respond) {
      req.on('timeout', onTimeout(time, next));
>>>>>>> 746d829ab6fde4cbabefa5c385905aefd0043a1d
    }

    req.clearTimeout = function(){
      clearTimeout(id);
    };

    req.socket.destroy = function(){
      clearTimeout(id);
      destroy.call(this);
    };

    req.timedout = false;

<<<<<<< HEAD
    var writeHead = res.writeHead;
    res.writeHead = function(){
      clearTimeout(id);
      writeHead.apply(res, arguments);
    }
=======
    onHeaders(res, function(){
      clearTimeout(id);
    });
>>>>>>> 746d829ab6fde4cbabefa5c385905aefd0043a1d

    next();
  };
};

<<<<<<< HEAD
function generateTimeoutError(){
  var err = new Error('Response timeout');
  err.code = 'ETIMEDOUT';
  err.status = 503;
  return err;
}

function onTimeout(ms, cb){
  return function(){
    if (this._header) return debug('response started, cannot timeout');
    var err = generateTimeoutError();
    err.timeout = ms;
    cb(err);
=======
function onTimeout(time, cb){
  return function(){
    cb(createError(503, 'Response timeout', {
      code: 'ETIMEDOUT',
      timeout: time
    }));
>>>>>>> 746d829ab6fde4cbabefa5c385905aefd0043a1d
  };
}
